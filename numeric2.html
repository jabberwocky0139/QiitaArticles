<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
</head>
<body>
<!---
  NumPyを用いた数値計算の高速化 : 応用
-->
<p><a href="http://qiita.com/jabberwocky0139/items/c3620fb2f011f20a633b">NumPyを用いた数値計算の高速化 : 基礎</a>のつづきです.</p>
<h1 id="対象">対象</h1>
<p>Python及びNumPy初心者に向けて書いています. 「C言語は使えるけど最近Pythonを始めた」とか「Pythonらしい書き方がよくわからない」に該当する物理系の数値計算を目的とした方には特に有用かもしれません.</p>
<p>また, 自分の不勉強のために間違った記述があるかもしれません. ご容赦ください.</p>
<h1 id="微分">微分</h1>
<p>物理の基礎方程式には微分がつきものです. 微分は線形写像なので行列方程式で記述できます. たとえばある関数の2回微分を計算するとしましょう. これを前進差分と後退差分を用いて表現することにします: <!---
$$-\frac{1}{2}\frac{d^2}{dx^2}\psi(x) = E_n\psi(x)$$
---></p>
<p><span class="math display">\[\frac{d^2}{dx^2}\psi(x) = \frac{\psi(x + \Delta x) - 2\psi(x) + \psi(x - \Delta x)}{\Delta x^2} + {\cal O}(\Delta x^2)\]</span></p>
<p><span class="math inline">\(\psi(x)\)</span>を空間<span class="math inline">\(L\)</span>を<span class="math inline">\(\Delta x\)</span>で差分化してあげると</p>
<p><span class="math display">\[\psi(x)\rightarrow \{\psi(x_0), \psi(x_1), ..., \psi(x_{n-1}), \psi(x_n)\} = \{\psi_0, \psi_1, ..., \psi_{n-1}, \psi_n\}\hspace{1cm}x_i = -L/2 + i\Delta x\]</span></p>
<p>微分は行列形式で書くことができます:</p>
<p><span class="math display">\[\frac{d^2}{dx^2}\psi(x) = \frac{1}{\Delta x^2}
\begin{pmatrix}
-2\psi_0&amp;\psi_1&amp;0&amp;\cdots&amp;0\\ 
\psi_0&amp;-2\psi_1 &amp;\psi_2&amp;\cdots&amp;0\\
0 &amp; \psi_1&amp;-2\psi_2&amp;&amp; \vdots\\
\vdots&amp;&amp;&amp;\ddots&amp;\psi_n\\
0&amp; \cdots&amp; 0 &amp;\psi_{n-1}&amp; -2\psi_n
\end{pmatrix}
= \frac{1}{\Delta x^2}
\begin{pmatrix}
-2&amp;1&amp;0&amp;\cdots&amp;0\\ 
1&amp;-2 &amp;1&amp;\cdots&amp;0\\
0 &amp; 1&amp;-2&amp;&amp; \vdots\\
\vdots&amp;&amp;&amp;\ddots&amp;1\\
0&amp; \cdots&amp; 0 &amp;1&amp; -2
\end{pmatrix}
\begin{pmatrix}
\psi_0\\
\psi_1\\
\vdots\\
\psi_{n-1}\\
\psi_n
\end{pmatrix}
=K\psi
\]</span></p>
<p>はじっこで嫌なことが起きていますが, <span class="math inline">\(\Delta x\)</span>が小さければ大丈夫です.</p>
<h2 id="実装">実装</h2>
<p>Pythonで実装してあげます. 初期関数を適当に用意して差分化してあげます:</p>
<pre class="py3"><code>&gt;&gt;&gt; import numpy as np
&gt;&gt;&gt; def f(x):
...     return np.exp(-x**2)
... 
&gt;&gt;&gt; L, N = 7, 100
&gt;&gt;&gt; x = np.linspace(-L/2, L/2, N)
&gt;&gt;&gt; psi = f(x)
&gt;&gt;&gt; psi
array([  4.78511739e-06,   7.81043424e-06,   1.26216247e-05,
         2.01935578e-05,   3.19865883e-05,   5.01626530e-05,
         7.78844169e-05,   1.19723153e-04,   1.82206228e-04,
         ...,
         2.74540100e-04,   1.82206228e-04,   1.19723153e-04,
         7.78844169e-05,   5.01626530e-05,   3.19865883e-05,
         2.01935578e-05,   1.26216247e-05,   7.81043424e-06,
         4.78511739e-06])</code></pre>
<p>そして微分の行列を用意します. そのためには劣対角成分に値を格納しなければなりません. そこで<code>ndarray</code>のスライスと<code>vstack</code>を組み合わせます:</p>
<pre class="py3"><code>&gt;&gt;&gt; K = np.eye(N, N)
&gt;&gt;&gt; K
array([[ 1.,  0.,  0., ...,  0.,  0.,  0.],
       [ 0.,  1.,  0., ...,  0.,  0.,  0.],
       [ 0.,  0.,  1., ...,  0.,  0.,  0.],
       ..., 
       [ 0.,  0.,  0., ...,  1.,  0.,  0.],
       [ 0.,  0.,  0., ...,  0.,  1.,  0.],
       [ 0.,  0.,  0., ...,  0.,  0.,  1.]])
&gt;&gt;&gt; K_sub = np.vstack((K[1:], np.array([0] * N)))
&gt;&gt;&gt; K_sub
array([[ 0.,  1.,  0., ...,  0.,  0.,  0.],
       [ 0.,  0.,  1., ...,  0.,  0.,  0.],
       [ 0.,  0.,  0., ...,  0.,  0.,  0.],
       ..., 
       [ 0.,  0.,  0., ...,  0.,  1.,  0.],
       [ 0.,  0.,  0., ...,  0.,  0.,  1.],
       [ 0.,  0.,  0., ...,  0.,  0.,  0.]])
&gt;&gt;&gt; K = -2 * K + K_sub + K_sub.T
&gt;&gt;&gt; K
array([[-2.,  1.,  0., ...,  0.,  0.,  0.],
       [ 1., -2.,  1., ...,  0.,  0.,  0.],
       [ 0.,  1., -2., ...,  0.,  0.,  0.],
       ..., 
       [ 0.,  0.,  0., ..., -2.,  1.,  0.],
       [ 0.,  0.,  0., ...,  1., -2.,  1.],
       [ 0.,  0.,  0., ...,  0.,  1., -2.]])</code></pre>
<p>これで微分が実行できます:</p>
<pre class="py3"><code>dx = L/N
psi_dot = dx**-2 * np.dot(K, psi)</code></pre>
<div class="figure">
<img src="figure1.png" alt="微分完了ですね" />
<p class="caption">微分完了ですね</p>
</div>
</body>
</html>
